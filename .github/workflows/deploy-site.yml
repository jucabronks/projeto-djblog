name: ğŸŒ Deploy Site EstÃ¡tico

on:
  # Executar quando push para main
  push:
    branches: [ main ]
  
  # Executar quando EventBridge dispara (via webhook)
  repository_dispatch:
    types: [update-news]
  
  # Executar diariamente Ã s 7:00 UTC (4:00 BRT)
  schedule:
    - cron: '0 7 * * *'
  
  # Permitir execuÃ§Ã£o manual
  workflow_dispatch:

# Configurar permissÃµes para GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Garantir que apenas um deploy rode por vez
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Gerar site estÃ¡tico
  generate-site:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install boto3 requests feedparser
        
    - name: ğŸ”§ Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: ğŸŒ Generate responsive static site
      env:
        AWS_REGION: ${{ secrets.AWS_REGION }}
        DYNAMODB_TABLE_NAME: ${{ secrets.DYNAMODB_TABLE_NAME }}
      run: |
        echo "ğŸš€ Gerando site estÃ¡tico responsivo e otimizado para SEO..."
        python generate_static_site.py
        
        # Criar estrutura otimizada do site
        mkdir -p site/assets/images
        mkdir -p site/assets/icons
        
        # Mover HTML principal
        mv index.html site/
        
        # Criar robots.txt
        echo "User-agent: *" > site/robots.txt
        echo "Allow: /" >> site/robots.txt
        echo "Sitemap: https://jucabronks.github.io/projeto-djblog/sitemap.xml" >> site/robots.txt
        
        # Criar sitemap.xml bÃ¡sico
        echo '<?xml version="1.0" encoding="UTF-8"?>' > site/sitemap.xml
        echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> site/sitemap.xml
        echo '  <url>' >> site/sitemap.xml
        echo '    <loc>https://jucabronks.github.io/projeto-djblog/</loc>' >> site/sitemap.xml
        echo "    <lastmod>$(date -u +%Y-%m-%d)</lastmod>" >> site/sitemap.xml
        echo '    <changefreq>daily</changefreq>' >> site/sitemap.xml
        echo '    <priority>1.0</priority>' >> site/sitemap.xml
        echo '  </url>' >> site/sitemap.xml
        echo '</urlset>' >> site/sitemap.xml
        
        echo "âœ… Site estÃ¡tico responsivo gerado com sucesso!"
        echo "ğŸ“Š Estrutura:"
        ls -la site/
    - name: ğŸ“Š Generate health report (Skip if no AWS credentials)
      continue-on-error: true
      env:
        AWS_REGION: ${{ secrets.AWS_REGION }}
        DYNAMODB_TABLE_NAME: ${{ secrets.DYNAMODB_TABLE_NAME }}
      run: |
        if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
          echo "ğŸ” Gerando relatÃ³rio de saÃºde..."
          python monitor_sistema.py || echo "âš ï¸ Monitor falhou, criando relatÃ³rio bÃ¡sico"
          mv health_report.json site/health.json 2>/dev/null || echo '{"status":"ok","message":"Sistema funcionando"}' > site/health.json
        else
          echo "â„¹ï¸ Pulando monitor (sem credenciais AWS)"
          echo '{"status":"demo","message":"Site demo funcionando"}' > site/health.json
        fi
        
    - name: ğŸ“ Setup Pages
      uses: actions/configure-pages@v4
      
    - name: ğŸ“¤ Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './site'
        
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # Job para notificar status
  notify:
    needs: generate-site
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“§ Notify deployment status
      if: failure()
      run: |
        echo "âš ï¸ Deploy falhou! Verifique os logs."
        # Aqui vocÃª pode adicionar notificaÃ§Ãµes por email/Slack/Discord
        
    - name: âœ… Success notification  
      if: success()
      run: |
        echo "ğŸ‰ Site atualizado com sucesso!"
        echo "ğŸŒ URL: https://${{ github.repository_owner }}.github.io/projeto-djblog"
